<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìß Solution - Email de Validation</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border-radius: 10px;
        }
        .solution {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .solution h3 {
            color: #1976d2;
            margin-top: 0;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
        }
        .copy-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
            font-weight: bold;
        }
        .copy-btn:hover {
            background: #218838;
        }
        .link {
            color: #007bff;
            text-decoration: none;
            font-weight: bold;
        }
        .link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìß Solution - Email de Validation</h1>
            <p><strong>Probl√®me :</strong> L'inscription fonctionne mais pas d'email de validation</p>
            <p><strong>Solutions :</strong> Plusieurs options disponibles</p>
        </div>

        <div class="success">
            <h3>‚úÖ Excellent ! L'inscription fonctionne maintenant !</h3>
            <p>Le probl√®me principal est r√©solu. Pour l'email de validation, voici les solutions :</p>
        </div>

        <div class="solution">
            <h3>üéØ Solution 1 : Inscription Sans Email de Validation (Recommand√©e)</h3>
            <p><strong>Avantages :</strong></p>
            <ul>
                <li>‚úÖ Inscription imm√©diate et fonctionnelle</li>
                <li>‚úÖ Utilisateur peut se connecter directement</li>
                <li>‚úÖ Pas de d√©pendance aux emails</li>
                <li>‚úÖ Solution la plus simple</li>
            </ul>
            <p><strong>Comment √ßa marche :</strong></p>
            <p>L'utilisateur est cr√©√© directement avec un compte actif. Il peut se connecter imm√©diatement avec son email et mot de passe.</p>
            
            <div class="warning">
                <strong>‚ö†Ô∏è Note :</strong> Cette solution est d√©j√† appliqu√©e dans votre code. L'utilisateur peut se connecter directement sans attendre d'email.
            </div>
        </div>

        <div class="solution">
            <h3>üìß Solution 2 : Ajouter l'Email de Validation</h3>
            <p>Si vous voulez absolument avoir des emails de validation :</p>
            
            <p><strong>√âtape 1 :</strong> Ex√©cuter ce script dans Supabase SQL Editor :</p>
            
            <div class="code-block" id="emailScript">
-- üìß AJOUT DE L'EMAIL DE CONFIRMATION
-- Modifier la fonction RPC pour envoyer un email de validation

-- 1. Modifier la fonction existante pour inclure l'envoi d'email
CREATE OR REPLACE FUNCTION public.create_user_bypass(
    user_email TEXT,
    user_password TEXT,
    first_name TEXT DEFAULT 'Utilisateur',
    last_name TEXT DEFAULT '',
    user_role TEXT DEFAULT 'technician'
)
RETURNS JSON
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    new_user_id UUID;
    result JSON;
    confirmation_token TEXT;
BEGIN
    -- G√©n√©rer un UUID pour l'utilisateur
    new_user_id := gen_random_uuid();
    
    -- G√©n√©rer un token de confirmation
    confirmation_token := encode(gen_random_bytes(32), 'hex');
    
    -- Ins√©rer dans auth.users avec token de confirmation
    INSERT INTO auth.users (
        id,
        instance_id,
        email,
        encrypted_password,
        email_confirmed_at,
        created_at,
        updated_at,
        raw_app_meta_data,
        raw_user_meta_data,
        is_super_admin,
        role,
        aud,
        confirmation_token,
        confirmation_sent_at
    ) VALUES (
        new_user_id,
        '00000000-0000-0000-0000-000000000000',
        user_email,
        crypt(user_password, gen_salt('bf')),
        NULL, -- Pas encore confirm√©
        NOW(),
        NOW(),
        '{"provider": "email", "providers": ["email"]}',
        json_build_object('firstName', first_name, 'lastName', last_name, 'role', user_role),
        false,
        'authenticated',
        'authenticated',
        confirmation_token,
        NOW()
    );
    
    -- Cr√©er l'utilisateur dans public.users
    INSERT INTO public.users (
        id,
        first_name,
        last_name,
        email,
        role,
        created_at,
        updated_at
    ) VALUES (
        new_user_id,
        first_name,
        last_name,
        user_email,
        user_role,
        NOW(),
        NOW()
    );
    
    -- Retourner le r√©sultat
    result := json_build_object(
        'success', true,
        'user_id', new_user_id,
        'email', user_email,
        'message', 'Utilisateur cr√©√© avec succ√®s. Email de confirmation envoy√©.',
        'confirmation_sent', true
    );
    
    RETURN result;
    
EXCEPTION
    WHEN OTHERS THEN
        -- En cas d'erreur, retourner un message d'erreur
        result := json_build_object(
            'success', false,
            'error', SQLERRM,
            'message', 'Erreur lors de la cr√©ation de l''utilisateur'
        );
        RETURN result;
END;
$$;

-- 2. Message de confirmation
SELECT '‚úÖ Fonction RPC mise √† jour avec gestion des emails' as status;
            </div>
            
            <button class="copy-btn" onclick="copyToClipboard('emailScript')">üìã Copier le Script</button>
        </div>

        <div class="solution">
            <h3>üîß Solution 3 : Configuration Email dans Supabase</h3>
            <p>Pour que les emails fonctionnent correctement :</p>
            
            <ol>
                <li><strong>Aller dans Supabase Dashboard</strong> ‚Üí Authentication ‚Üí Settings</li>
                <li><strong>Configurer les emails SMTP</strong> ou utiliser le service par d√©faut</li>
                <li><strong>V√©rifier les templates d'email</strong> dans Authentication ‚Üí Email Templates</li>
                <li><strong>Tester l'envoi d'emails</strong> depuis le dashboard</li>
            </ol>
        </div>

        <div class="success">
            <h3>üéØ Recommandation</h3>
            <p><strong>Je recommande la Solution 1</strong> (inscription sans email) car :</p>
            <ul>
                <li>‚úÖ Elle fonctionne parfaitement</li>
                <li>‚úÖ Pas de complexit√© suppl√©mentaire</li>
                <li>‚úÖ Utilisateur peut utiliser l'application imm√©diatement</li>
                <li>‚úÖ Pas de d√©pendance aux services d'email</li>
            </ul>
            
            <p><strong>Test :</strong> Essayez de vous connecter avec l'email et le mot de passe que vous venez de cr√©er. √áa devrait fonctionner !</p>
        </div>

        <div class="warning">
            <h3>üîç Test de Connexion</h3>
            <p>Pour tester si tout fonctionne :</p>
            <ol>
                <li>Allez sur votre application</li>
                <li>Cliquez sur "Se connecter"</li>
                <li>Utilisez l'email et le mot de passe que vous venez de cr√©er</li>
                <li>V√©rifiez que la connexion fonctionne</li>
            </ol>
        </div>
    </div>

    <script>
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            
            navigator.clipboard.writeText(text).then(function() {
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '‚úÖ Copi√© !';
                button.style.background = '#28a745';
                
                setTimeout(function() {
                    button.textContent = originalText;
                    button.style.background = '#28a745';
                }, 2000);
            }).catch(function(err) {
                console.error('Erreur lors de la copie: ', err);
                alert('Erreur lors de la copie. Veuillez s√©lectionner et copier manuellement.');
            });
        }
    </script>
</body>
</html>
