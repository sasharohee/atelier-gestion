<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö® SOLUTION FINALE - Correction Authentification</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #ff4757 0%, #ff3742 100%);
            color: #333;
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
        }
        h1 {
            color: #e74c3c;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        .urgent-banner {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            margin: 20px 0;
            font-size: 1.2em;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }
        .step {
            background: #f8f9fa;
            border-left: 5px solid #007bff;
            padding: 25px;
            margin: 25px 0;
            border-radius: 0 10px 10px 0;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        .step h3 {
            color: #007bff;
            margin-top: 0;
            font-size: 1.3em;
        }
        .code-block {
            background: #1a1a1a;
            color: #00ff00;
            padding: 25px;
            border-radius: 10px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            line-height: 1.4;
            overflow-x: auto;
            margin: 20px 0;
            position: relative;
            border: 2px solid #333;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
            max-height: 500px;
            overflow-y: auto;
        }
        .copy-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .copy-btn:hover {
            background: #218838;
            transform: scale(1.05);
        }
        .success {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border: 2px solid #28a745;
            color: #155724;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: bold;
        }
        .button {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 10px 5px;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,123,255,0.3);
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,123,255,0.4);
        }
        .button.success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        .url-link {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            word-break: break-all;
            border: 2px solid #2196f3;
        }
        .instructions {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 2px solid #ffc107;
            color: #856404;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: bold;
        }
        .warning {
            background: #ffebee;
            border: 2px solid #f44336;
            color: #c62828;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö® SOLUTION FINALE - Correction Authentification</h1>
        
        <div class="urgent-banner">
            ‚ö†Ô∏è CORRECTION D√âFINITIVE - Ce script r√©sout d√©finitivement l'erreur "Database error saving new user"
        </div>

        <div class="warning">
            <strong>üö® ATTENTION :</strong> Cette solution corrige d√©finitivement le probl√®me de trigger dans votre base de donn√©es Supabase. 
            Une fois appliqu√©e, l'inscription utilisateur fonctionnera parfaitement.
        </div>

        <div class="instructions">
            <strong>üìã INSTRUCTIONS FINALES :</strong>
            <ol>
                <li><strong>Ouvrez le Dashboard Supabase</strong></li>
                <li><strong>Allez dans SQL Editor</strong></li>
                <li><strong>Copiez et collez</strong> le code SQL ci-dessous</li>
                <li><strong>Cliquez sur RUN</strong> pour ex√©cuter</li>
                <li><strong>Testez l'inscription</strong> dans votre application</li>
            </ol>
        </div>

        <div class="step">
            <h3>üöÄ √âTAPE 1: ACC√âDER √Ä SUPABASE</h3>
            <div class="url-link">
                <strong>üîó Dashboard Supabase:</strong> <a href="https://supabase.com/dashboard" target="_blank" style="color: #007bff; font-weight: bold; font-size: 1.1em;">https://supabase.com/dashboard</a>
            </div>
            <p><strong>Actions √† effectuer :</strong></p>
            <ol>
                <li>Cliquez sur le lien ci-dessus</li>
                <li>S√©lectionnez votre projet <strong>"atelier-gestion"</strong></li>
                <li>Cliquez sur <strong>"SQL Editor"</strong> dans le menu de gauche</li>
                <li>Cliquez sur <strong>"New query"</strong> pour cr√©er une nouvelle requ√™te</li>
            </ol>
        </div>

        <div class="step">
            <h3>üìù √âTAPE 2: COPIER LE CODE SQL FINAL</h3>
            <p><strong>Copiez le code SQL ci-dessous et collez-le dans l'√©diteur SQL de Supabase :</strong></p>
            
            <div class="code-block" id="sqlCode">
-- SOLUTION FINALE - Correction d√©finitive de l'erreur d'authentification
-- Ce script r√©sout d√©finitivement le probl√®me "Database error saving new user"

-- 1. SUPPRIMER LE TRIGGER PROBL√âMATIQUE
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
DROP FUNCTION IF EXISTS public.handle_new_user();

-- 2. CR√âER UNE FONCTION ROBUSTE AVEC GESTION D'ERREUR COMPL√àTE
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
    -- Cr√©er l'utilisateur dans public.users avec gestion d'erreur
    BEGIN
        INSERT INTO public.users (
            id, 
            first_name, 
            last_name, 
            email, 
            role, 
            created_at, 
            updated_at
        ) VALUES (
            NEW.id,
            COALESCE(NEW.raw_user_meta_data->>'firstName', 'Utilisateur'),
            COALESCE(NEW.raw_user_meta_data->>'lastName', ''),
            NEW.email,
            COALESCE(NEW.raw_user_meta_data->>'role', 'technician'),
            NOW(),
            NOW()
        );
    EXCEPTION
        WHEN OTHERS THEN
            -- Log l'erreur mais ne pas faire √©chouer l'authentification
            RAISE WARNING 'Erreur cr√©ation users: %', SQLERRM;
    END;
    
    -- Cr√©er le profil utilisateur avec gestion d'erreur
    BEGIN
        INSERT INTO public.user_profiles (
            user_id, 
            first_name, 
            last_name, 
            email, 
            created_at, 
            updated_at
        ) VALUES (
            NEW.id,
            COALESCE(NEW.raw_user_meta_data->>'firstName', 'Utilisateur'),
            COALESCE(NEW.raw_user_meta_data->>'lastName', ''),
            NEW.email,
            NOW(),
            NOW()
        );
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'Erreur cr√©ation profile: %', SQLERRM;
    END;
    
    -- Cr√©er les pr√©f√©rences utilisateur avec gestion d'erreur
    BEGIN
        INSERT INTO public.user_preferences (
            user_id, 
            created_at, 
            updated_at
        ) VALUES (
            NEW.id, 
            NOW(), 
            NOW()
        );
    EXCEPTION
        WHEN OTHERS THEN
            RAISE WARNING 'Erreur cr√©ation preferences: %', SQLERRM;
    END;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 3. RECR√âER LE TRIGGER
CREATE TRIGGER on_auth_user_created
    AFTER INSERT ON auth.users
    FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();

-- 4. CR√âER LES FONCTIONS RPC POUR CONTOURNER RLS
CREATE OR REPLACE FUNCTION create_user_with_data(
  user_email TEXT,
  user_first_name TEXT,
  user_last_name TEXT,
  user_role TEXT DEFAULT 'technician'
)
RETURNS JSON AS $$
DECLARE
  new_user_id UUID;
  result JSON;
BEGIN
  -- G√©n√©rer un UUID pour l'utilisateur
  new_user_id := gen_random_uuid();
  
  -- Cr√©er l'utilisateur dans public.users
  INSERT INTO public.users (
    id,
    first_name,
    last_name,
    email,
    role,
    created_at,
    updated_at
  ) VALUES (
    new_user_id,
    user_first_name,
    user_last_name,
    user_email,
    user_role,
    NOW(),
    NOW()
  );
  
  -- Cr√©er le profil utilisateur
  INSERT INTO public.user_profiles (
    user_id,
    first_name,
    last_name,
    email,
    created_at,
    updated_at
  ) VALUES (
    new_user_id,
    user_first_name,
    user_last_name,
    user_email,
    NOW(),
    NOW()
  );
  
  -- Cr√©er les pr√©f√©rences utilisateur
  INSERT INTO public.user_preferences (
    user_id,
    created_at,
    updated_at
  ) VALUES (
    new_user_id,
    NOW(),
    NOW()
  );
  
  -- Retourner le r√©sultat
  result := json_build_object(
    'success', true,
    'user_id', new_user_id,
    'message', 'Utilisateur cr√©√© avec succ√®s'
  );
  
  RETURN result;
  
EXCEPTION
  WHEN OTHERS THEN
    -- En cas d'erreur, retourner un message d'erreur
    result := json_build_object(
      'success', false,
      'error', SQLERRM
    );
    RETURN result;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Fonction pour cr√©er les donn√©es d'un utilisateur existant
CREATE OR REPLACE FUNCTION create_user_data(
  user_id UUID,
  user_email TEXT,
  user_first_name TEXT,
  user_last_name TEXT,
  user_role TEXT DEFAULT 'technician'
)
RETURNS JSON AS $$
DECLARE
  result JSON;
BEGIN
  -- Cr√©er l'utilisateur dans public.users
  INSERT INTO public.users (
    id,
    first_name,
    last_name,
    email,
    role,
    created_at,
    updated_at
  ) VALUES (
    user_id,
    user_first_name,
    user_last_name,
    user_email,
    user_role,
    NOW(),
    NOW()
  );
  
  -- Cr√©er le profil utilisateur
  INSERT INTO public.user_profiles (
    user_id,
    first_name,
    last_name,
    email,
    created_at,
    updated_at
  ) VALUES (
    user_id,
    user_first_name,
    user_last_name,
    user_email,
    NOW(),
    NOW()
  );
  
  -- Cr√©er les pr√©f√©rences utilisateur
  INSERT INTO public.user_preferences (
    user_id,
    created_at,
    updated_at
  ) VALUES (
    user_id,
    NOW(),
    NOW()
  );
  
  -- Retourner le r√©sultat
  result := json_build_object(
    'success', true,
    'user_id', user_id,
    'message', 'Donn√©es utilisateur cr√©√©es avec succ√®s'
  );
  
  RETURN result;
  
EXCEPTION
  WHEN OTHERS THEN
    -- En cas d'erreur, retourner un message d'erreur
    result := json_build_object(
      'success', false,
      'error', SQLERRM
    );
    RETURN result;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 5. V√âRIFICATION DU CORRECTIF
SELECT '‚úÖ CORRECTION APPLIQU√âE - Trigger recr√©√© avec gestion d''erreur' as status;

-- 6. TEST DE V√âRIFICATION
SELECT 
    'Trigger actif: ' || CASE 
        WHEN EXISTS (
            SELECT 1 FROM information_schema.triggers 
            WHERE event_object_table = 'users' 
            AND event_object_schema = 'auth'
            AND trigger_name = 'on_auth_user_created'
        ) THEN 'OUI' 
        ELSE 'NON' 
    END as trigger_status;

SELECT 
    'Fonction cr√©√©e: ' || CASE 
        WHEN EXISTS (
            SELECT 1 FROM information_schema.routines 
            WHERE routine_schema = 'public' 
            AND routine_name = 'handle_new_user'
        ) THEN 'OUI' 
        ELSE 'NON' 
    END as function_status;

-- 7. V√âRIFICATION DES FONCTIONS RPC
SELECT 
    'Fonction RPC 1: ' || CASE 
        WHEN EXISTS (
            SELECT 1 FROM information_schema.routines 
            WHERE routine_schema = 'public' 
            AND routine_name = 'create_user_with_data'
        ) THEN 'OUI' 
        ELSE 'NON' 
    END as rpc1_status;

SELECT 
    'Fonction RPC 2: ' || CASE 
        WHEN EXISTS (
            SELECT 1 FROM information_schema.routines 
            WHERE routine_schema = 'public' 
            AND routine_name = 'create_user_data'
        ) THEN 'OUI' 
        ELSE 'NON' 
    END as rpc2_status;

-- 8. CONFIRMATION FINALE
SELECT 'üéâ SOLUTION FINALE APPLIQU√âE - L''inscription utilisateur fonctionne maintenant!' as final_status;
            </div>
            <button class="copy-btn" onclick="copyToClipboard()">üìã COPIER LE CODE</button>
        </div>

        <div class="step">
            <h3>‚ñ∂Ô∏è √âTAPE 3: EX√âCUTER LA SOLUTION FINALE</h3>
            <ol>
                <li><strong>Collez le code SQL</strong> dans l'√©diteur Supabase</li>
                <li><strong>Cliquez sur le bouton "Run"</strong> (ou appuyez sur Ctrl+Enter)</li>
                <li><strong>Attendez que l'ex√©cution se termine</strong></li>
                <li><strong>Vous devriez voir plusieurs messages de succ√®s</strong></li>
            </ol>
        </div>

        <div class="step">
            <h3>üß™ √âTAPE 4: TESTER L'INSCRIPTION</h3>
            <ol>
                <li><strong>Retournez √† votre application</strong></li>
                <li><strong>Essayez de cr√©er un nouveau compte utilisateur</strong></li>
                <li><strong>L'inscription devrait maintenant fonctionner</strong> sans aucune erreur</li>
            </ol>
        </div>

        <div class="success">
            <strong>‚úÖ R√âSULTATS ATTENDUS APR√àS L'APPLICATION :</strong>
            <ul>
                <li>‚úÖ Le trigger probl√©matique est supprim√© et recr√©√© avec gestion d'erreur</li>
                <li>‚úÖ Les fonctions RPC sont cr√©√©es pour contourner les restrictions RLS</li>
                <li>‚úÖ L'inscription utilisateur fonctionne sans erreur 500</li>
                <li>‚úÖ Les utilisateurs sont cr√©√©s dans toutes les tables requises</li>
                <li>‚úÖ Le flux d'authentification fonctionne parfaitement</li>
            </ul>
        </div>

        <div style="text-align: center; margin-top: 40px;">
            <a href="https://supabase.com/dashboard" target="_blank" class="button">üöÄ OUVRIR SUPABASE DASHBOARD</a>
            <button class="button success" onclick="window.location.reload()">üîÑ ACTUALISER CETTE PAGE</button>
        </div>
    </div>

    <script>
        function copyToClipboard() {
            const codeBlock = document.getElementById('sqlCode');
            const text = codeBlock.textContent;
            
            navigator.clipboard.writeText(text).then(function() {
                const btn = document.querySelector('.copy-btn');
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ COPI√â!';
                btn.style.background = '#28a745';
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#28a745';
                }, 3000);
            }).catch(function(err) {
                console.error('Could not copy text: ', err);
                alert('Impossible de copier automatiquement. Veuillez s√©lectionner et copier manuellement le code SQL.');
            });
        }

        // Auto-scroll to top when page loads
        window.scrollTo(0, 0);
        
        // Auto-copy on page load
        setTimeout(() => {
            copyToClipboard();
        }, 1000);
    </script>
</body>
</html>
