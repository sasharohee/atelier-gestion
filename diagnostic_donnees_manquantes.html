<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic Donn√©es Manquantes</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .data-display {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        .section h3 {
            margin-top: 0;
            color: #495057;
        }
        .count {
            font-size: 1.2em;
            font-weight: bold;
            color: #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagnostic Donn√©es Manquantes</h1>
        
        <div class="info">
            <strong>Objectif :</strong> V√©rifier pourquoi les donn√©es cr√©√©es ne sont plus visibles.
        </div>

        <div id="status-container">
            <div class="status info">
                <strong>En attente...</strong> Cliquez sur "Diagnostiquer" pour commencer.
            </div>
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <button onclick="diagnoseMissingData()">üîç Diagnostiquer</button>
            <button onclick="restoreDefaultData()">üîÑ Restaurer les Donn√©es</button>
            <button onclick="clearResults()">üóëÔ∏è Effacer</button>
        </div>

        <div id="results"></div>

        <div class="section">
            <h3>üìä R√©sultats du Diagnostic</h3>
            <div id="data-display"></div>
        </div>
    </div>

    <!-- Import de Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Configuration Supabase
        const SUPABASE_URL = 'https://olrihggkxyksuofkesnk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9scmloZ2dreXZrc3VvZmtlc25rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ5NTQ4MDQsImV4cCI6MjA1MDUzMDgwNH0.7nXqKqKqKqKqKqKqKqKqKqKqKqKqKqKqKqKqKqKqK';

        let supabase;

        function updateStatus(message, type = 'info') {
            const statusContainer = document.getElementById('status-container');
            statusContainer.innerHTML = `<div class="status ${type}"><strong>${message}</strong></div>`;
        }

        function addResult(message, type = 'info') {
            const resultsContainer = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `status ${type}`;
            resultDiv.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            resultsContainer.appendChild(resultDiv);
            resultsContainer.scrollTop = resultsContainer.scrollHeight;
        }

        function displayData(data) {
            const dataContainer = document.getElementById('data-display');
            dataContainer.textContent = JSON.stringify(data, null, 2);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('data-display').textContent = '';
            updateStatus('R√©sultats effac√©s. Pr√™t pour un nouveau diagnostic.', 'info');
        }

        async function diagnoseMissingData() {
            updateStatus('üîç Diagnostic en cours...', 'info');
            addResult('D√©but du diagnostic des donn√©es manquantes...');

            const diagnosticResults = {
                connection: { success: false, error: null },
                categories: { count: 0, data: [], error: null },
                brands: { count: 0, data: [], error: null },
                models: { count: 0, data: [], error: null },
                brandCategories: { count: 0, data: [], error: null }
            };

            try {
                // Test 1: Initialiser Supabase
                addResult('Test 1: Initialisation de Supabase...');
                try {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    diagnosticResults.connection.success = true;
                    addResult('‚úÖ Supabase initialis√© avec succ√®s');
                } catch (error) {
                    diagnosticResults.connection.error = error.message;
                    addResult(`‚ùå Erreur lors de l'initialisation: ${error.message}`);
                    displayData(diagnosticResults);
                    return;
                }

                // Test 2: V√©rifier les cat√©gories
                addResult('Test 2: V√©rification des cat√©gories...');
                try {
                    const { data, error } = await supabase.from('device_categories').select('*');
                    if (error) {
                        diagnosticResults.categories.error = error.message;
                        addResult(`‚ùå Erreur cat√©gories: ${error.message}`);
                    } else {
                        diagnosticResults.categories.count = data.length;
                        diagnosticResults.categories.data = data;
                        addResult(`‚úÖ ${data.length} cat√©gories trouv√©es`);
                    }
                } catch (error) {
                    diagnosticResults.categories.error = error.message;
                    addResult(`‚ùå Erreur cat√©gories: ${error.message}`);
                }

                // Test 3: V√©rifier les marques
                addResult('Test 3: V√©rification des marques...');
                try {
                    const { data, error } = await supabase.from('device_brands').select('*');
                    if (error) {
                        diagnosticResults.brands.error = error.message;
                        addResult(`‚ùå Erreur marques: ${error.message}`);
                    } else {
                        diagnosticResults.brands.count = data.length;
                        diagnosticResults.brands.data = data;
                        addResult(`‚úÖ ${data.length} marques trouv√©es`);
                    }
                } catch (error) {
                    diagnosticResults.brands.error = error.message;
                    addResult(`‚ùå Erreur marques: ${error.message}`);
                }

                // Test 4: V√©rifier les mod√®les
                addResult('Test 4: V√©rification des mod√®les...');
                try {
                    const { data, error } = await supabase.from('device_models').select('*');
                    if (error) {
                        diagnosticResults.models.error = error.message;
                        addResult(`‚ùå Erreur mod√®les: ${error.message}`);
                    } else {
                        diagnosticResults.models.count = data.length;
                        diagnosticResults.models.data = data;
                        addResult(`‚úÖ ${data.length} mod√®les trouv√©s`);
                    }
                } catch (error) {
                    diagnosticResults.models.error = error.message;
                    addResult(`‚ùå Erreur mod√®les: ${error.message}`);
                }

                // Test 5: V√©rifier les relations marque-cat√©gorie
                addResult('Test 5: V√©rification des relations marque-cat√©gorie...');
                try {
                    const { data, error } = await supabase.from('brand_categories').select('*');
                    if (error) {
                        diagnosticResults.brandCategories.error = error.message;
                        addResult(`‚ùå Erreur relations: ${error.message}`);
                    } else {
                        diagnosticResults.brandCategories.count = data.length;
                        diagnosticResults.brandCategories.data = data;
                        addResult(`‚úÖ ${data.length} relations marque-cat√©gorie trouv√©es`);
                    }
                } catch (error) {
                    diagnosticResults.brandCategories.error = error.message;
                    addResult(`‚ùå Erreur relations: ${error.message}`);
                }

                // Afficher les r√©sultats
                displayData(diagnosticResults);

                // R√©sum√©
                const totalData = diagnosticResults.categories.count + diagnosticResults.brands.count + diagnosticResults.models.count;
                if (totalData === 0) {
                    updateStatus('‚ùå Aucune donn√©e trouv√©e - Base de donn√©es vide', 'error');
                    addResult('‚ùå Aucune donn√©e trouv√©e. La base de donn√©es est vide.', 'error');
                    addResult('üí° Cliquez sur "Restaurer les Donn√©es" pour recr√©er les donn√©es par d√©faut.', 'warning');
                } else if (totalData < 10) {
                    updateStatus('‚ö†Ô∏è Peu de donn√©es trouv√©es', 'warning');
                    addResult(`‚ö†Ô∏è Seulement ${totalData} √©l√©ments trouv√©s. Certaines donn√©es peuvent √™tre manquantes.`, 'warning');
                } else {
                    updateStatus('‚úÖ Donn√©es trouv√©es', 'success');
                    addResult(`‚úÖ ${totalData} √©l√©ments trouv√©s. Les donn√©es semblent correctes.`, 'success');
                }

            } catch (error) {
                updateStatus('‚ùå Erreur lors du diagnostic', 'error');
                addResult(`‚ùå Erreur: ${error.message}`);
                displayData({ error: error.message });
            }
        }

        async function restoreDefaultData() {
            updateStatus('üîÑ Restauration des donn√©es...', 'info');
            addResult('D√©but de la restauration des donn√©es par d√©faut...');

            try {
                // Initialiser Supabase si pas d√©j√† fait
                if (!supabase) {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                }

                // 1. Cr√©er une cat√©gorie par d√©faut
                addResult('Cr√©ation d\'une cat√©gorie par d√©faut...');
                const { data: categoryData, error: categoryError } = await supabase
                    .from('device_categories')
                    .insert([{
                        name: '√âlectronique',
                        description: 'Cat√©gorie par d√©faut pour les appareils √©lectroniques',
                        icon: 'smartphone',
                        is_active: true,
                        user_id: null,
                        created_by: null
                    }])
                    .select()
                    .single();

                if (categoryError) {
                    addResult(`‚ö†Ô∏è Erreur cr√©ation cat√©gorie: ${categoryError.message}`, 'warning');
                } else {
                    addResult(`‚úÖ Cat√©gorie cr√©√©e: ${categoryData.name}`);
                }

                // 2. Cr√©er les marques par d√©faut
                addResult('Cr√©ation des marques par d√©faut...');
                const defaultBrands = [
                    { id: '1', name: 'Apple', description: 'Fabricant am√©ricain de produits √©lectroniques premium' },
                    { id: '2', name: 'Samsung', description: 'Fabricant sud-cor√©en d\'√©lectronique grand public' },
                    { id: '3', name: 'Google', description: 'Entreprise am√©ricaine de technologie' },
                    { id: '4', name: 'Microsoft', description: 'Entreprise am√©ricaine de technologie' },
                    { id: '5', name: 'Sony', description: 'Conglom√©rat japonais d\'√©lectronique' }
                ];

                for (const brand of defaultBrands) {
                    const { error: brandError } = await supabase
                        .from('device_brands')
                        .upsert([{
                            id: brand.id,
                            name: brand.name,
                            description: brand.description,
                            logo: '',
                            is_active: true,
                            user_id: null,
                            created_by: null
                        }]);

                    if (brandError) {
                        addResult(`‚ö†Ô∏è Erreur cr√©ation marque ${brand.name}: ${brandError.message}`, 'warning');
                    } else {
                        addResult(`‚úÖ Marque cr√©√©e: ${brand.name}`);
                    }
                }

                // 3. Cr√©er les relations marque-cat√©gorie
                if (categoryData) {
                    addResult('Cr√©ation des relations marque-cat√©gorie...');
                    for (const brand of defaultBrands) {
                        const { error: relationError } = await supabase
                            .from('brand_categories')
                            .upsert([{
                                brand_id: brand.id,
                                category_id: categoryData.id
                            }]);

                        if (relationError) {
                            addResult(`‚ö†Ô∏è Erreur relation ${brand.name}: ${relationError.message}`, 'warning');
                        } else {
                            addResult(`‚úÖ Relation cr√©√©e: ${brand.name} - √âlectronique`);
                        }
                    }
                }

                updateStatus('‚úÖ Restauration termin√©e', 'success');
                addResult('üéâ Restauration des donn√©es termin√©e !', 'success');
                addResult('üí° Rechargez l\'application pour voir les donn√©es restaur√©es.', 'info');

            } catch (error) {
                updateStatus('‚ùå Erreur lors de la restauration', 'error');
                addResult(`‚ùå Erreur: ${error.message}`);
            }
        }

        // Diagnostic automatique au chargement
        window.addEventListener('load', () => {
            addResult('üìÑ Page de diagnostic charg√©e');
            addResult('üí° Cliquez sur "Diagnostiquer" pour commencer');
        });
    </script>
</body>
</html>
