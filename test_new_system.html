<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test du Nouveau Syst√®me de Marques</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .step {
            margin: 20px 0;
            padding: 15px;
            border-left: 4px solid #007bff;
            background-color: #f8f9fa;
        }
        .success {
            border-left-color: #28a745;
            background-color: #d4edda;
        }
        .error {
            border-left-color: #dc3545;
            background-color: #f8d7da;
        }
        .warning {
            border-left-color: #ffc107;
            background-color: #fff3cd;
        }
        code {
            background-color: #e9ecef;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
        }
        .sql-code {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .copy-btn {
            background-color: #28a745;
            font-size: 12px;
            padding: 5px 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test du Nouveau Syst√®me de Marques</h1>
        
        <div class="step success">
            <h3>‚úÖ √âtape 1 : Fichiers de l'application mis √† jour</h3>
            <p>Les fichiers suivants ont √©t√© remplac√©s :</p>
            <ul>
                <li><code>src/services/brandService.ts</code> - Nouveau service pour les marques</li>
                <li><code>src/pages/Catalog/DeviceManagement.tsx</code> - Nouveau composant</li>
            </ul>
            <p>Les anciens fichiers ont √©t√© sauvegard√©s avec timestamp.</p>
        </div>

        <div class="step warning">
            <h3>‚ö†Ô∏è √âtape 2 : Script SQL √† ex√©cuter</h3>
            <p>Vous devez maintenant ex√©cuter le script SQL dans Supabase :</p>
            
            <button class="copy-btn" onclick="copySQL()">üìã Copier le Script SQL</button>
            
            <div class="sql-code" id="sqlScript">
-- Script SQL √† ex√©cuter dans Supabase
-- 1. Allez sur https://supabase.com/dashboard
-- 2. Ouvrez votre projet
-- 3. Allez dans SQL Editor
-- 4. Copiez et collez ce script
-- 5. Cliquez sur "Run"

-- SUPPRIMER LES FONCTIONS EXISTANTES
DROP FUNCTION IF EXISTS public.update_brand_categories(text, uuid[]) CASCADE;
DROP FUNCTION IF EXISTS public.upsert_brand(text, text, text, text, uuid[]) CASCADE;

-- SUPPRIMER LES VUES
DROP VIEW IF EXISTS public.brand_with_categories CASCADE;

-- SUPPRIMER LES CONTRAINTES
ALTER TABLE public.brand_categories DROP CONSTRAINT IF EXISTS brand_categories_brand_id_fkey;
ALTER TABLE public.device_models DROP CONSTRAINT IF EXISTS device_models_brand_id_fkey;
ALTER TABLE public.device_brands DROP CONSTRAINT IF EXISTS device_brands_pkey;
ALTER TABLE public.brand_categories DROP CONSTRAINT IF EXISTS brand_categories_pkey;

-- MODIFIER LES TYPES DE COLONNES
ALTER TABLE public.device_brands ALTER COLUMN id TYPE TEXT;
ALTER TABLE public.brand_categories ALTER COLUMN brand_id TYPE TEXT;
ALTER TABLE public.device_models ALTER COLUMN brand_id TYPE TEXT;

-- RECR√âER LES CONTRAINTES
ALTER TABLE public.device_brands ADD CONSTRAINT device_brands_pkey PRIMARY KEY (id);
ALTER TABLE public.brand_categories ADD CONSTRAINT brand_categories_pkey PRIMARY KEY (id);
ALTER TABLE public.brand_categories ADD CONSTRAINT brand_categories_brand_id_fkey FOREIGN KEY (brand_id) REFERENCES public.device_brands(id) ON DELETE CASCADE;
ALTER TABLE public.device_models ADD CONSTRAINT device_models_brand_id_fkey FOREIGN KEY (brand_id) REFERENCES public.device_brands(id) ON DELETE CASCADE;

-- CR√âER LA VUE
CREATE VIEW public.brand_with_categories AS
SELECT 
    db.id,
    db.name,
    db.description,
    db.logo,
    db.is_active,
    db.user_id,
    db.created_by,
    db.created_at,
    db.updated_at,
    COALESCE(
        json_agg(
            json_build_object(
                'id', dc.id,
                'name', dc.name,
                'description', dc.description,
                'icon', dc.icon
            )
        ) FILTER (WHERE dc.id IS NOT NULL),
        '[]'::json
    ) as categories
FROM public.device_brands db
LEFT JOIN public.brand_categories bc ON db.id = bc.brand_id
LEFT JOIN public.device_categories dc ON bc.category_id = dc.id
GROUP BY db.id, db.name, db.description, db.logo, db.is_active, db.user_id, db.created_by, db.created_at, db.updated_at;

ALTER VIEW public.brand_with_categories SET (security_invoker = true);

-- CR√âER LES FONCTIONS
CREATE OR REPLACE FUNCTION public.update_brand_categories(
    p_brand_id TEXT,
    p_category_ids UUID[]
) RETURNS JSON AS $$
DECLARE
    v_user_id UUID;
    v_result JSON;
    v_category_id UUID;
BEGIN
    BEGIN
        v_user_id := auth.uid();
    EXCEPTION WHEN OTHERS THEN
        v_user_id := NULL;
    END;
    
    IF v_user_id IS NULL THEN
        IF NOT EXISTS (SELECT 1 FROM device_brands WHERE id = p_brand_id) THEN
            RAISE EXCEPTION 'Marque non trouv√©e';
        END IF;
        
        DELETE FROM brand_categories WHERE brand_id = p_brand_id;
        
        IF p_category_ids IS NOT NULL AND array_length(p_category_ids, 1) > 0 THEN
            FOREACH v_category_id IN ARRAY p_category_ids
            LOOP
                IF EXISTS (SELECT 1 FROM device_categories WHERE id = v_category_id) THEN
                    INSERT INTO brand_categories (brand_id, category_id)
                    VALUES (p_brand_id, v_category_id)
                    ON CONFLICT (brand_id, category_id) DO NOTHING;
                END IF;
            END LOOP;
        END IF;
    ELSE
        IF NOT EXISTS (SELECT 1 FROM device_brands WHERE id = p_brand_id AND user_id = v_user_id) THEN
            RAISE EXCEPTION 'Marque non trouv√©e ou non autoris√©e';
        END IF;
        
        DELETE FROM brand_categories WHERE brand_id = p_brand_id;
        
        IF p_category_ids IS NOT NULL AND array_length(p_category_ids, 1) > 0 THEN
            FOREACH v_category_id IN ARRAY p_category_ids
            LOOP
                IF EXISTS (SELECT 1 FROM device_categories WHERE id = v_category_id AND user_id = v_user_id) THEN
                    INSERT INTO brand_categories (brand_id, category_id)
                    VALUES (p_brand_id, v_category_id)
                    ON CONFLICT (brand_id, category_id) DO NOTHING;
                END IF;
            END LOOP;
        END IF;
    END IF;
    
    SELECT json_build_object(
        'id', db.id,
        'name', db.name,
        'description', db.description,
        'logo', db.logo,
        'is_active', db.is_active,
        'categories', COALESCE(
            json_agg(
                json_build_object(
                    'id', dc.id,
                    'name', dc.name,
                    'description', dc.description,
                    'icon', dc.icon
                )
            ) FILTER (WHERE dc.id IS NOT NULL),
            '[]'::json
        )
    ) INTO v_result
    FROM device_brands db
    LEFT JOIN brand_categories bc ON db.id = bc.brand_id
    LEFT JOIN device_categories dc ON bc.category_id = dc.id
    WHERE db.id = p_brand_id
    GROUP BY db.id, db.name, db.description, db.logo, db.is_active;
    
    RETURN v_result;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE OR REPLACE FUNCTION public.upsert_brand(
    p_id TEXT,
    p_name TEXT,
    p_description TEXT DEFAULT '',
    p_logo TEXT DEFAULT '',
    p_category_ids UUID[] DEFAULT NULL
) RETURNS JSON AS $$
DECLARE
    v_user_id UUID;
    v_result JSON;
BEGIN
    BEGIN
        v_user_id := auth.uid();
    EXCEPTION WHEN OTHERS THEN
        v_user_id := NULL;
    END;
    
    IF v_user_id IS NULL THEN
        INSERT INTO device_brands (id, name, description, logo, user_id, created_by)
        VALUES (p_id, p_name, p_description, p_logo, NULL, NULL)
        ON CONFLICT (id) DO UPDATE SET
            name = EXCLUDED.name,
            description = EXCLUDED.description,
            logo = EXCLUDED.logo,
            updated_at = NOW();
    ELSE
        INSERT INTO device_brands (id, name, description, logo, user_id, created_by)
        VALUES (p_id, p_name, p_description, p_logo, v_user_id, v_user_id)
        ON CONFLICT (id) DO UPDATE SET
            name = EXCLUDED.name,
            description = EXCLUDED.description,
            logo = EXCLUDED.logo,
            updated_at = NOW()
        WHERE device_brands.user_id = v_user_id;
    END IF;
    
    IF p_category_ids IS NOT NULL THEN
        PERFORM public.update_brand_categories(p_id, p_category_ids);
    END IF;
    
    SELECT json_build_object(
        'id', db.id,
        'name', db.name,
        'description', db.description,
        'logo', db.logo,
        'is_active', db.is_active,
        'categories', COALESCE(
            json_agg(
                json_build_object(
                    'id', dc.id,
                    'name', dc.name,
                    'description', dc.description,
                    'icon', dc.icon
                )
            ) FILTER (WHERE dc.id IS NOT NULL),
            '[]'::json
        )
    ) INTO v_result
    FROM device_brands db
    LEFT JOIN brand_categories bc ON db.id = bc.brand_id
    LEFT JOIN device_categories dc ON bc.category_id = dc.id
    WHERE db.id = p_id
    GROUP BY db.id, db.name, db.description, db.logo, db.is_active;
    
    RETURN v_result;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- CR√âER LES MARQUES PAR D√âFAUT
INSERT INTO device_categories (name, description, icon, is_active, user_id, created_by)
VALUES ('√âlectronique', 'Cat√©gorie par d√©faut', 'smartphone', true, NULL, NULL)
ON CONFLICT DO NOTHING;

DO $$
DECLARE
    v_category_id UUID;
BEGIN
    SELECT id INTO v_category_id FROM device_categories 
    WHERE name = '√âlectronique' LIMIT 1;
    
    INSERT INTO device_brands (id, name, description, logo, is_active, user_id, created_by)
    VALUES 
        ('1', 'Apple', 'Fabricant am√©ricain de produits √©lectroniques premium', '', true, NULL, NULL),
        ('2', 'Samsung', 'Fabricant sud-cor√©en d''√©lectronique grand public', '', true, NULL, NULL),
        ('3', 'Google', 'Entreprise am√©ricaine de technologie', '', true, NULL, NULL),
        ('4', 'Microsoft', 'Entreprise am√©ricaine de technologie', '', true, NULL, NULL),
        ('5', 'Sony', 'Conglom√©rat japonais d''√©lectronique', '', true, NULL, NULL)
    ON CONFLICT (id) DO UPDATE SET
        name = EXCLUDED.name,
        description = EXCLUDED.description,
        logo = EXCLUDED.logo,
        updated_at = NOW();
    
    IF v_category_id IS NOT NULL THEN
        INSERT INTO brand_categories (brand_id, category_id)
        VALUES 
            ('1', v_category_id),
            ('2', v_category_id),
            ('3', v_category_id),
            ('4', v_category_id),
            ('5', v_category_id)
        ON CONFLICT (brand_id, category_id) DO NOTHING;
    END IF;
    
    RAISE NOTICE '‚úÖ Marques par d√©faut cr√©√©es avec succ√®s';
END $$;

-- V√âRIFICATION
SELECT 'V√©rification des marques cr√©√©es:' as info;
SELECT id, name, description FROM device_brands ORDER BY name;

SELECT 'Test de la fonction upsert_brand:' as info;
SELECT public.upsert_brand('test', 'Test', 'Description test', '', ARRAY[(SELECT id FROM device_categories LIMIT 1)]) as result;

DELETE FROM device_brands WHERE id = 'test';

SELECT '‚úÖ Script ex√©cut√© avec succ√®s !' as result;
            </div>
        </div>

        <div class="step">
            <h3>üîß √âtape 3 : Test du nouveau syst√®me</h3>
            <p>Apr√®s avoir ex√©cut√© le script SQL :</p>
            <ol>
                <li>Allez dans <strong>"Gestion des Appareils"</strong> > <strong>"Marques"</strong></li>
                <li>Cliquez sur <strong>"Modifier"</strong> pour Apple</li>
                <li>V√©rifiez que vous pouvez maintenant :</li>
                <ul>
                    <li>‚úÖ Modifier le nom de la marque</li>
                    <li>‚úÖ Modifier la description</li>
                    <li>‚úÖ Ajouter/supprimer des cat√©gories</li>
                    <li>‚úÖ Voir le titre "Modifier la marque" (au lieu de "Modifier les cat√©gories de la marque pr√©d√©finie")</li>
                </ul>
            </ol>
        </div>

        <div class="step success">
            <h3>üéâ R√©sultat Attendu</h3>
            <p>Apr√®s la migration compl√®te, vous pourrez modifier <strong>TOUTES</strong> les marques sans restriction :</p>
            <ul>
                <li>‚úÖ <strong>Apple</strong> - Enti√®rement modifiable</li>
                <li>‚úÖ <strong>Samsung</strong> - Enti√®rement modifiable</li>
                <li>‚úÖ <strong>Google</strong> - Enti√®rement modifiable</li>
                <li>‚úÖ <strong>Microsoft</strong> - Enti√®rement modifiable</li>
                <li>‚úÖ <strong>Sony</strong> - Enti√®rement modifiable</li>
                <li>‚úÖ <strong>Nouvelles marques</strong> - Cr√©ation et modification</li>
            </ul>
        </div>

        <div class="step error">
            <h3>üö® En cas de probl√®me</h3>
            <p>Si vous rencontrez encore des erreurs :</p>
            <ul>
                <li>V√©rifiez que le script SQL a √©t√© ex√©cut√© sans erreur</li>
                <li>V√©rifiez les logs de la console du navigateur</li>
                <li>Red√©marrez le serveur de d√©veloppement : <code>npm run dev</code></li>
                <li>Les anciens fichiers sont sauvegard√©s avec timestamp</li>
            </ul>
        </div>
    </div>

    <script>
        function copySQL() {
            const sqlText = document.getElementById('sqlScript').textContent;
            navigator.clipboard.writeText(sqlText).then(() => {
                alert('‚úÖ Script SQL copi√© dans le presse-papiers !');
            }).catch(() => {
                alert('‚ùå Erreur lors de la copie. Copiez manuellement le script.');
            });
        }
    </script>
</body>
</html>
